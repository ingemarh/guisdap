#!/bin/sh
wd=/opt/webgup
wwwreq="anareg.txt"
locreq="anareq_done.txt"
wwwsite="http://www.eiscat.se/schedule"
export PATH=$PATH:/usr/local/bin

fsiz() {
	filesize=`ls -l $1 | awk '{print $5}'`
	#return `ls -l $1 | awk '{print $5}'`
}
mail_it() {
	nail -s "Analysis results" -r "GUISDAP <ingemar@eiscat.se>" $* <<!
Enclosed you find the requested analysis.
EISCAT
!
}

cd $wd
if ! wget $wwwsite/$wwwreq -O $wwwreq 2>/dev/null
then
 #echo "Could not reach HQ"
 exit 0
elif cmp -s $wwwreq $locreq
then
 #echo "All already done"
 exit 0
else
 QUERY_STRING=`comm -23 $wwwreq $locreq | head -n1`
fi
fsiz $wwwreq
nsiz=$filesize
fsiz $locreq
if [ -z $QUERY_STRING ] || [ $nsiz -lt $filesize ]
then
 echo "New list"
 cp $wwwreq $locreq
 exit 0
fi
echo $QUERY_STRING >> $locreq


QUERY_STRING=`echo $QUERY_STRING | sed s/%3A/:/g | sed s/%2F/"\/"/g | sed s/%40/@/g | sed s/%5B/[/g | sed s/%5D/]/g | sed s/%0./#/g`
eval `echo $QUERY_STRING | sed  y/"&"/" "/`
datapath=`echo $datapath | sed s/%3B/\;/g | sed y/+/\ /`
t=`echo $t | sed y/+/\ /`
extra=`echo $extra | sed s/%28/\(/g | sed s/%29/\)/ | sed s/%3B/\;/g | sed s/%3D/=/g | sed s/%26/"\&"/g | sed s/%7B/\{/g | sed s/%7D/\}/g  | sed s/%5E/^/g | sed s/%7E/~/g | sed s/%27/\'\'/g | sed s/%3C/\</g | sed s/%3E/\>/g | sed s/%2C/,/g | sed y/+/\ / | sed s/%2B/+/g | sed s/%25/%/g`

atpos=`expr index "$resultpath" "@"`
if [ -z $resultpath ] || [ $atpos -eq 0 ]
then
 echo "Nowhere to send results"
 exit 1
else
 echo "$resultpath"
fi
rundir=www$RANDOM
mkdir $rundir
cd $rundir
gfdfil=gfd.m
for tar in $datapath
do
 wget -O - "$tar" 2>/dev/null | tar xf -
done
ls | grep information | xargs rm -rf
datapath=`ls`
if [ -z $datapath ]
then
 echo "No data defined"
 exit 1
fi
touch $gfdfil
maxsize=3000000
if [ $maxfsize ]
then
 maxsize=$(($maxfsize*730000)) #uuencoding maxes file ~27% bigger 
fi

ed $gfdfil 2>/dev/null <<!
a
name_expr='$name_expr';
siteid=$siteid;
data_path='$datapath';
result_path='AUTO';
t1=[$t 0 0 0];
t2=[$t 24 0 0];
rt=0;
intper=$intper;
path_exps=[path_GUP '/exps/'];
figs=[0 0 0 0 1];
expver=$expver;
extra=[' $extra'];
.
w
q
!
#guisdap -tg $gfdfil " -c /opt/matlab7/etc/license.dat" >gupout.txt
guisdap -tg $gfdfil >gupout.txt
rm -rf $datapath $gfdfil
gzip -9 gupout.txt
filelist="gupout.txt.gz"
resdir=`ls -d [12]*`
if [ $resdir ]
then
 nextfile=`ls $resdir/NCAR* 2>/dev/null`
 if [ $nextfile ]
 then
  mv $resdir/NCAR* .
  bzip2 -9 NCAR*
 fi
 inhouse="@eiscat.se @eiscat.irf.se @eiscat.sgo.fi @eiscat.uit.no @esr.eiscat.no"
 datrep="denis.alcayde@cesr.fr steve@mail.eiscat.rl.ac.uk cesar.la.hoz@phys.uit.no hans.nilsson@irf.se ritva.kuula@oulu.fi nozawa@stelab.nagoya-u.ac.jp mike@eiscat.uit.no"

 trusted=0
 mh=`expr substr $resultpath $atpos 99`
 for eis in $inhouse
 do
  if [ "$eis" = "$mh" ]
  then
   trusted=1
  fi
 done 
 for eis in $datrep
 do
  if [ "$eis" = "$resultpath" ]
  then
   trusted=1
  fi
 done 
 nextfile=`ls $resdir/*.png 2>/dev/null`
 if [ $nextfile ]
 then
  mv $resdir/*.png $resdir/*.eps .
  filelist="`ls *.png` $filelist"
 elif [ $trusted -eq 0 ]
 then
  trusted=2
 fi
 if [ $trusted -eq 1 ]
 then
  if [ $nextfile ]
  then
   bzip2 -9 *.eps
  fi
  tar cf - $resdir | bzip2 -9c > $resdir.tar.bz2
 elif [ $trusted -eq 0 ] && [ $nextfile ]
 then
  ps2pdf -sPAPERSIZE=a4 *.eps
  filelist="$filelist `ls *.pdf`"
 fi
 filelist="$filelist `ls *.bz2`"
 rm -rf $resdir
fi
flist=""
for fil in $filelist
do
 fsiz $fil
 if [ $filesize -gt $maxsize ]
 then
  split -db $maxsize $fil $fil.
  flist="$flist `ls $fil.??`"
 else
  flist="$flist $fil"
 fi
done
nsiz=0
matt=""
for fil in $flist
do
 fsiz $fil
 if [ $((nsiz+filesize)) -gt $maxsize ] && [ $nsiz -ne 0 ]
 then
  mail_it $matt $resultpath
  sleep 30
  matt=""
  nsiz=0
 fi
 matt="$matt -a $fil"
 nsiz=$((nsiz+filesize))
done
mail_it $matt $resultpath
cd ..
#rm -rf $rundir
